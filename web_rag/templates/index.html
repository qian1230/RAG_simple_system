<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG å¯è§†åŒ–æ£€ç´¢ç³»ç»Ÿ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            border-radius: 0 0 1rem 1rem;
            margin-bottom: 2rem;
        }
        .search-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .result-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        .result-card.low-score {
            border-left-color: #e74c3c;
        }
        .result-content {
            max-height: 300px;
            overflow-y: auto;
        }
        .metadata {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 1rem;
        }
        .btn-primary {
            background: #667eea;
            border: none;
        }
        .btn-primary:hover {
            background: #764ba2;
        }
        .spinner {
            display: none;
        }
        .spinner.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1 class="display-4">RAG å¯è§†åŒ–æ£€ç´¢ç³»ç»Ÿ</h1>
            <p class="lead">åŸºäºå‘é‡æ•°æ®åº“çš„æ™ºèƒ½æ–‡æ¡£æ£€ç´¢</p>
        </div>
    </div>

    <div class="container">
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-card mb-4">
            <h2 class="mb-4">ğŸ” æ™ºèƒ½æ£€ç´¢</h2>
            <form id="search-form">
                <div class="mb-3">
                    <label for="query" class="form-label">æŸ¥è¯¢è¯</label>
                    <input type="text" class="form-control form-control-lg" id="query" name="query"
                           placeholder="ä¾‹å¦‚ï¼šå”‡è¯» æ·±åº¦å­¦ä¹  è®ºæ–‡" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                        <span id="search-text">å¼€å§‹æ£€ç´¢</span>
                        <span id="search-spinner" class="spinner spinner-border spinner-border-sm ms-2"></span>
                    </button>
                    <button type="button" id="check-qdrant" class="btn btn-secondary btn-lg">
                        æ£€æŸ¥ Qdrant
                    </button>
                </div>
            </form>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="search-card mb-4">
            <h2 class="mb-4">ğŸ“ æ–‡ä»¶ä¸Šä¼ </h2>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label">é€‰æ‹© PDF æ–‡ä»¶</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".pdf" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="upload-text">ä¸Šä¼ å¹¶å…¥åº“</span>
                    <span id="upload-spinner" class="spinner spinner-border spinner-border-sm ms-2"></span>
                </button>
            </form>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="results" class="mb-4">
            <!-- ç»“æœå°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
        </div>

        <!-- Qdrant æ£€æŸ¥ç»“æœ -->
        <div id="qdrant-result" class="mb-4">
            <!-- æ£€æŸ¥ç»“æœå°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- è‡ªå®šä¹‰è„šæœ¬ -->
    <script>
        // æœç´¢è¡¨å•æäº¤
        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = document.getElementById('query').value.trim();
            if (!query) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('search-text').textContent = 'æ£€ç´¢ä¸­...';
            document.getElementById('search-spinner').classList.add('show');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('results').innerHTML = '';
            
            // å‘é€è¯·æ±‚
            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('search-text').textContent = 'å¼€å§‹æ£€ç´¢';
                document.getElementById('search-spinner').classList.remove('show');
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                document.getElementById('search-text').textContent = 'å¼€å§‹æ£€ç´¢';
                document.getElementById('search-spinner').classList.remove('show');
                showError('æ£€ç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        });

        // æ£€æŸ¥ Qdrant
        document.getElementById('check-qdrant').addEventListener('click', function() {
            const button = this;
            const originalText = button.textContent;
            button.textContent = 'æ£€æŸ¥ä¸­...';
            button.disabled = true;
            
            fetch('/check_qdrant')
            .then(response => response.json())
            .then(data => {
                button.textContent = originalText;
                button.disabled = false;
                
                if (data.success) {
                    displayQdrantResult(data.output);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                button.textContent = originalText;
                button.disabled = false;
                showError('æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        });

        // ä¸Šä¼ è¡¨å•æäº¤
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('upload-text').textContent = 'ä¸Šä¼ ä¸­...';
            document.getElementById('upload-spinner').classList.add('show');
            
            // å‘é€è¯·æ±‚
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('upload-text').textContent = 'ä¸Šä¼ å¹¶å…¥åº“';
                document.getElementById('upload-spinner').classList.remove('show');
                
                if (data.success) {
                    showSuccess(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…±ç”Ÿæˆ ${data.chunks} ä¸ªå‘é‡`);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                document.getElementById('upload-text').textContent = 'ä¸Šä¼ å¹¶å…¥åº“';
                document.getElementById('upload-spinner').classList.remove('show');
                showError('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        });

        // æ˜¾ç¤ºæ£€ç´¢ç»“æœ
        function displayResults(data) {
            const resultsContainer = document.getElementById('results');
            
            if (data.total === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        æœªæ‰¾åˆ°ç›¸å…³å†…å®¹
                    </div>
                `;
                return;
            }
            
            let html = `
                <h2 class="mb-3">ğŸ“Š æ£€ç´¢ç»“æœ (${data.total} æ¡)</h2>
                <p class="text-muted">æŸ¥è¯¢è¯ï¼š${data.query}</p>
            `;
            
            data.results.forEach((result, index) => {
                const isLowScore = result.score < 0.5;
                const cardClass = isLowScore ? 'result-card low-score' : 'result-card';
                
                html += `
                    <div class="${cardClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <h3>ç»“æœ ${index + 1}</h3>
                            <span class="badge ${isLowScore ? 'bg-danger' : 'bg-success'}">
                                ç›¸ä¼¼åº¦: ${result.score}
                            </span>
                        </div>
                        <div class="result-content mt-2">
                            ${result.content}
                        </div>
                        <div class="metadata">
                            <strong>å…ƒæ•°æ®ï¼š</strong>
                            <pre>${JSON.stringify(result.metadata, null, 2)}</pre>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        // æ˜¾ç¤º Qdrant æ£€æŸ¥ç»“æœ
        function displayQdrantResult(output) {
            const container = document.getElementById('qdrant-result');
            container.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">Qdrant æ£€æŸ¥ç»“æœ</h4>
                    <pre class="mt-2">${output}</pre>
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const container = document.getElementById('results');
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <strong>é”™è¯¯ï¼š</strong> ${message}
                </div>
            `;
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const container = document.getElementById('results');
            container.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <strong>æˆåŠŸï¼š</strong> ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
